name: CI

on:
  # Disabled automatic push triggers - run only on PRs or manual dispatch
  # push:
  #   branches: [ main, develop, netflow-collector, lab ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov pytest-xdist pytest-benchmark
        pip install -e .
    
    - name: Run unit tests
      run: |
        pytest tests/unit/ -v --cov=src/clarion --cov-report=term-missing --cov-report=xml
    
    - name: Run integration tests
      run: |
        pytest tests/integration/ -v
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      continue-on-error: true
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

  validate-ground-truth:
    name: Validate Ground Truth Datasets
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
        pip install -e .
    
    - name: Generate ground truth datasets
      run: |
        python tests/data/ground_truth/generator.py enterprise
        python tests/data/ground_truth/generator.py healthcare
        python tests/data/ground_truth/generator.py manufacturing
        python tests/data/ground_truth/generator.py education
        python tests/data/ground_truth/generator.py retail
    
    - name: Validate dataset loading
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from pathlib import Path
        from clarion.ingest.loader import load_dataset
        
        datasets = ['enterprise', 'healthcare', 'manufacturing', 'education', 'retail']
        for dataset in datasets:
            try:
                data = load_dataset(Path(f'tests/data/ground_truth/{dataset}'))
                print(f'✓ {dataset}: {len(data.flows):,} flows, {len(data.endpoints):,} endpoints')
            except Exception as e:
                print(f'✗ {dataset}: {e}')
                sys.exit(1)
        "
    
    - name: Run clustering validation tests
      run: |
        pytest tests/integration/test_clustering_accuracy.py -v || echo "Validation tests failed (non-blocking)"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black ruff mypy
        pip install -e .
    
    - name: Check code formatting with Black
      run: |
        black --check src/ tests/ || true
    
    - name: Run Ruff linter
      run: |
        ruff check src/ tests/ || true
    
    - name: Type check with mypy
      run: |
        mypy src/clarion --ignore-missing-imports || true

  frontend-test:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Verify TypeScript version
      working-directory: frontend
      run: npx tsc --version
    
    - name: Run frontend tests
      working-directory: frontend
      run: npm test -- --coverage --watchAll=false --passWithNoTests || true
    
    - name: Build frontend
      working-directory: frontend
      run: npm run build

  collector-test:
    name: Test NetFlow Collector
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev
    
    - name: Install collector dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r collector/requirements.txt
        pip install pytest pytest-asyncio
    
    - name: Run collector unit tests
      run: |
        pytest collector/tests/ -v || echo "Collector tests failed (non-blocking)"

  performance-benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-benchmark
        pip install -e .
    
    - name: Generate ground truth dataset
      run: |
        python tests/data/ground_truth/generator.py enterprise
    
    - name: Run performance benchmarks
      run: |
        pytest tests/benchmark/ -v --benchmark-only --benchmark-json=benchmark_results.json || true
    
    - name: Upload benchmark results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.json
        retention-days: 30
        if-no-files-found: ignore

  notify:
    name: Test Notifications
    runs-on: ubuntu-latest
    needs: [test, validate-ground-truth, lint, frontend-test, collector-test]
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request')
    
    steps:
    - name: Check job status
      id: check
      run: |
        if [ "${{ needs.test.result }}" == "failure" ] || \
           [ "${{ needs.validate-ground-truth.result }}" == "failure" ] || \
           [ "${{ needs.lint.result }}" == "failure" ] || \
           [ "${{ needs.frontend-test.result }}" == "failure" ] || \
           [ "${{ needs.collector-test.result }}" == "failure" ]; then
          echo "status=failure" >> $GITHUB_OUTPUT
        else
          echo "status=success" >> $GITHUB_OUTPUT
        fi
    
    - name: Send email notification on failure
      if: steps.check.outputs.status == 'failure'
      uses: dawidd6/action-send-mail@v3
      continue-on-error: true
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Clarion CI Failed: ${{ github.workflow }} #${{ github.run_number }}"
        to: sgerhart@gmail.com
        from: GitHub Actions
        body: |
          CI Pipeline failed for Clarion project.
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          Failed Jobs:
          - Test: ${{ needs.test.result }}
          - Validate Ground Truth: ${{ needs.validate-ground-truth.result }}
          - Lint: ${{ needs.lint.result }}
          - Frontend Test: ${{ needs.frontend-test.result }}
          - Collector Test: ${{ needs.collector-test.result }}
          
          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        html_body: |
          <h2>CI Pipeline Failed</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
          <p><strong>Commit:</strong> ${{ github.sha }}</p>
          <p><strong>Author:</strong> ${{ github.actor }}</p>
          
          <h3>Failed Jobs:</h3>
          <ul>
            <li>Test: ${{ needs.test.result }}</li>
            <li>Validate Ground Truth: ${{ needs.validate-ground-truth.result }}</li>
            <li>Lint: ${{ needs.lint.result }}</li>
            <li>Frontend Test: ${{ needs.frontend-test.result }}</li>
            <li>Collector Test: ${{ needs.collector-test.result }}</li>
          </ul>
          
          <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>

